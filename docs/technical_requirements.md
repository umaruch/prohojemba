# 1. Цель проекта
Цель проекта - разработать Систему для отслеживания пользователями пройденных/просмотренных тайтлов(игр, фильмов, аниме, сериалов), а также для отметки планируемых к прохождению/просмотру.

# 2. Описание системы
Система состоит из следующих функциональных блоков:
1. Регистрация, аутентификация и авторизация
2. Функционал для работы с профиллями
3. Функционал для тайтлов
4. Функционал для активностей
5. Функционал для обзоров
6. Уведомления о критических ошибках в email

## 2.1 Регистрация, аутентификация и авторизация
Аутентификация будет проходить по принципу Token-Based Authentication
[Описание](https://gist.github.com/zmts/802dc9c3510d79fd40f9dc38a12bccfc)

Все действия в приложения могут выполнять только авторизованные пользователи.

### 2.1.1 Регистрация
Пользователь отправляет запрос на регистрацию с email для валидации. После ему на почту приходит код для проверки email.

При регистрации нового пользователя должны быть запрошены следующие поля:
- email
- username
- password
- code - код, отправленный по email

### 2.1.2 Аутентификация
При аутентификации пользователя должны быть запрошены следующие поля:
- email
- password

В результате возвращаются access токен, refresh токен и время истечения жизни access токена в формате UNIX timestamp.

### 2.1.3 Авторизация
Все запросы пользователя приложение делает с access токеном в заголовках (Authorization: Bearer <Токен>)

Access токен имеет ограниченное время жизни, когда приложение делает запрос с устаревшим токеном, то Система отправляет предупреждение.

Для обновления устаревшего access токена нужно отправить запрос на обновление со следующими полями:
- refresh_token - содержит refresh токен, выданный при регистрации, входе или предыдущем обновлении токенов.

### 2.1.4 Восстановление пароля
Сначала отправляется запрос на смену пароля, на почту отправляется код для подтверждения.

При восстановлении пароля должны быть запрошены следующие поля:
- email
- code - код, отправленный по email

После пользователь отправляет новый пароль с кодом подтверждения 

### 2.1.5 Изменение пароля
При изменении пароля должны быть запрошены следующие поля:
- current_password
- new_password

### 2.1.6 Изменение текущей почты
Сначала отправляется запрос на смену почты с указанием нового email,  на почту отправляется код для подтверждения.

Далее должны быть запрошены следующие поля:
- email - новый email
- password - пароль
- code - код, отправленный на новую почту

## 2.2 Функционал для профиля пользователя
Профиль пользователя будет состоять из нескольких таблиц. Основная это user, где будут храниться данные для авторизации:
- id
- email
- password_hash
- joined_at - дата регистрации
- last_auth_at - дата последнего входа

В дополнительной(profile) будет храниться вся остальная информация о пользователе:
- username
- avatar
- возможно ссылки на профили в разных соцсетях

### 2.2.1 Просмотр профиля
Если пользователь запрашивает свой профиль то ему выдается полная информация, то выдаваемая информация включает в себя email.

В профиле сверху указывается аватар и имя пользователя, чуть ниже отображается дополнительная информация. 

### 2.2.2 Пользовательские активности
Активности деляться по группам тайтлов, изначально сортировка по дате последнего обновления. Можно фильтровать по статусу(статус выбирается в отдельном пункте меню).

Так-же при просмотре активностей нам доступна информация и о связанном тайтле.

### 2.2.3 Пользовательские обзоры
Обзоры сортируются по дате последнего обновления, можно фильтровать по группам тайтлов.

Обзоры, отображаемые в профиле содержат в себе информацию о тайтле.

### 2.2.4 Редактирование профиля
Настройки отдельный пункт где пользователю доступны смена текущей почты, пароя, имени и всякой дополнительнйо информации.

## 2.3 Функционал для тайтлов
Таблица тайтла состоит из следующих полей:
- id
- name - Название тайтла
- cover - Обложка тайтла
- description - Описание тайтла
- type - Тип тайтла
- release_year - Год релиза
- rating - средний рейтинг

Типы тайтлов: game, movie, series, anime, book, comic, manga

### 2.3.1 Просмотр списка тайтлов
Тайтлы делятся по группам, нельзя запрашивать тайтлы, принадлежащие разным группам кучей.
Список тайтлов выдается постранично, по умолчанию все сортируется по id. Так-же доступен поиск по имени и сортировка по году релиза и рейтингу.

### 2.3.2 Просмотр информации о тайтле
На основной странице тайтла доступна обложка, название и группа. Чуть ниже отображается описание. 

Показ статуса активность если такой имеется, иначе выбор статуса.
ТОже самое с обзором

### 2.3.3 Добавление информации о тайтле
При создании новой записи о тайтле должны быть запрошены следующие поля:
- name
- description
- type
- release_year

### 2.3.4 Редактирование информации о тайтле
При редактировании текущей записи должны быть запрошены следующие поля:
- name
- description
- type 
- release_year

Изменение обложки тайтла выполняется отдельно.

### 2.3.5 Удаление тайтла
Для удаления тайтла достаточно передать его id.

### 2.3.6 Просмотр обзоров на тайтл
Обзоры сортируются по дате последнего обновления, также можно отсортировать по рейтингу.

Обзоры содержат в себе информацию о пользователе.

### 2.3.7 Просмотр активностей, связанных с тайтлов
Активности сортируются по дате последнего обновления. Можно фильтровать по статусу(статус выбирается в отдельном пункте меню).

Так-же при просмотре активностей нам доступна информация и пользователе.

## 2.4 Функционал для активностей
Таблица активностей состоит из следующих полей:
- id
- title_id - отсылается к тайтлу, который отметил проходжембец
- user_id - отсылается к проходжембцу, который отметил тайтл
- state - состояние прохождения - выбирается из константных значений (В процессе, Пройдено, 100%)
- updated_at - дата последнего обновления
- Тайтл и пользователь для каждого прохождения должны быть уникальны.

State может иметь следующие значения:
- planned - активность запланированна, т.е. пользователь только собирается в будущем играть, читать и т.д.
- active - активность в процессе исполнения (игра проходится, книга читается etc.)
- complete - активность завершена

### 2.4.1 Добавление активности
При добавлении активности должны быть запрошены следующие поля:
- title_id
- state

### 2.4.2 Редактирование активности
Для редактирования активности должны быть запрошены следующие поля:
- state

### 2.4.3 Удаление активности
Для удаления активности достаточно передать его id. Удалять можно только собственные активности.

## 2.5 Функционал для обзоров
Таблица обзоров состоит из следующих полей:
- id
- title_id - отсылается к тайтлу, который отметил проходжембец
- user_id - отсылается к проходжембцу, который отметил тайтл 
- rating - Оценка пользователя (0-100)    
- text - Текстовый обзор пользователя
- updated_at - дата последнего обновления
- Тайтл и пользователь для каждого отзыва должны быть уникальны.

*При любом взаимодействии с обзором обновляется рейтинг тайтла.

### 2.5.1 Добавление обзора
При добавлении обзора должны быть запрошены следующие поля:
- title_id
- rating - число от 0 до 100.
- text - текстовое обоснование оценки.

### 2.5.2 Редактирование обзора
При редактировании отзыва должны быть запрошены следующие поля:
- rating
- text

### 2.5.3 Удаление обзора
Для удаления отзыва достаточно передать его id. Удалять можно только собственные отзывы.

# 3. Предполагаемый стек технологий
Для реализации системы предполагается использовать следующие технологии:
- Бэкенд
    - Язык Python
    - FastAPI фреймворк 
    - БД PostgreSQL
    - SQLAlchemy ORM
    - Alembic для миграций
    - Redis для временного хранения токенов
    - Aioredis для взаимодействия с Redis
    - aiosmtplib для работы с электронной почтой

- Фронтенд
    - Язык JavaScript
    - Vue

- Android клиент
    - Язык Dart
    - Flutter

- Discord бот
    - Язык JavaScript

# 4. Требования к дизайну
Примерный дизайн: https://www.figma.com/file/58KcFSoHUynxjC0e9tBYth/Untitled?node-id=0%3A1

# 5. Требования к Discord боту (раздел постановки в состоянии доработки)
Функционал бота предусматривает следующие операции для пользователя, связавшего аккаунты discord и prohojemba
1. Добавление новых записей:
- Записи о прохождении/прочтении/просмотре
- Записи о планировании
2. Получение сводок. Предусмотреть возможность получать отчёты по шаблону, а также по набору кастомных параметров.
- Параметры для отчёта:
    - Тип элемента (игра/тайтл/книга/манга)
    - Наименование элемента
    - Статус записи (пройдено/прочитано/просмотрено или нет)
- Шаблоны отчётов:
    - Отобразить все запланированные элементы (возможно, с выбором типа)
    - Перечень новых элементов за период времени (пройдено игр за год, прочитано книг за месяц etc.)

Взаимодействие с ботом предполагается с применением эфемерных сообщений.
Призыв бота осуществлять командой в любом чате.
Сообщения бота должны содержать в себе интерактивные элементы для взаимодействия.

*TODO Подумать над необходимостью возможности выбирать, присылать отчёты в эфемерных сообщениях (видны только взаимодействующему с ботом пользователю) или публично (чтобы понтануться наличием кучи бесполезно потраченного свободного времени)*

# 6. Список URL API
/api/v1/ - основной url для отправки запросов на сервер

## 6.1. Авторизация
POST /auth/signin - регистрация

POST /auth/token - получение пары токенов авторизации

POST /auth/token/update - обновление токенов

POST /auth/email/change - изменение текущей почты

POST /auth/password/change - изменение пароля

POST /auth/password/restore - востановление забытого пароля

## 6.2. Профиль
GET|PATCH /user/@me - получение информации о текущем пользователе | Редактирование пользователя

POST /user/@me/avatar - изменение аватара пользователя

GET /user/{user_id} - получение информации о пользователе

GET /user/{user_id}/walks - полученение прохождений пользователя

GET /user/{user_id}/reviews - получение обзоров пользователя 

## 6.3. Тайтлы
GET|POST /titles - получение страницы с тайтлами | Создание тайтла

PATCH /titles/{title_id} - редактирование информации о тайтле

POST /titles/{title_id}/cover - добавление или редактирование обложки тайтла

DELETE /titles/{title_id} - удаление тайтла

GET /titles/{title_id}/reviews - получение пользовательских отзывов на тайтл

GET /titles/{title_id}/walks - получение прохождений

## 7.4. Прохождения
POST|PATCH /walks - создание или редактирование прохождения

DELETE /walks/{walk_id} - удаление прохождения

## 7.6. Отзывы
POST|PATCH /walks - создание или редактирование прохождения

DELETE /walks/{walk_id} - удаление прохождения

# 8. Над сим убожеством страдают
- Некошекс
    - Изначальная концепция и прототип в гугл таблицах
    - Бэкенд
    - Вэб морда
    - Разработка документации

- Акомото
    - Android клиент
    - Разработка документации
    - Немного дизайна

- Мао
    - Discord бот

- Лерой
    - Дизайн
    - Набор идей, принесённых в виде GeekList